---
title: 'Nodule Analysis: A Fiji plugin for nodule data collection'
tags:
  - Java
  - ImageJ
  - FIJI
  - biology
authors:
  - name: Brandin Farris
    orcid: 0009-0002-2462-6094
    equal-contrib: true
    affiliation: "1, 2" # (Multiple affiliations must be quoted)
  - name: Bala Krishanmoorthy
	orcid: 0000-0002-2727-6547
    equal-contrib: false # (This is how you can denote equal contributions between multiple authors)
    affiliation: 2
affiliations:
 - name: Washington State University
   index: 1
 - name: Porter Labs
   index: 2
date: 21 March 2025
bibliography: paper.bib
---

# Summary

When performing analysis on hundreds of plants of root systems that have been 
imaged, it is useful to have a high throughput method for gathering the data
from the plants. Fiji is a java based software extending ImageJ2 for performing analysis on biological images [@fiji1].
Nodule Analysis is a set of two Fiji (ImageJ2) plugins (Nodule Segmentation
and Nodule Distances) that provides a method for computing the counts, areas, and pair-wise distances along 
the root system of all of the nodules on an image of a root system using various data gathering methods. 
The plugin utilizes part of Weka's FIJI plugin, particularly their unsupervised color clustering method to segment the nodules and 
the root system separately[@Weka]. 


# Statement of need

There are currently no unsupervised methods that automates the collection
of nodule counts,sizes, and distances between nodules along the root system.
Root Painter is a program that utilizes deep learning to perform segmentation of a 
variety of biological images[@RootPainter]. Root Painter has been shown to count nodules
effectively, with relatively small error( $R^2 = .69$), but it does not consistently
fully outline the nodules, and does not compute their area, only the counts. Additionally,
it utilizes machine learning to improve the output of the data. Our method utilizes 
an unsupervised method for segmentation with some automated post-processing methods
to improve the segmentation, and uses the segmentation to compute the area as opposed to 
just the counts. The user is still granted an opportunity to make changes to the output of the data
before the plugin saves the results. 
Additionally, to our knowledge there is not currently a plugin that takes images of plants and 
compute the distances between marked objects on the plant along the plant's branches.


# Methods

We utilize Weka's unsupervised learning method, **Color Clustering** as an initial segmentation phase for the nodules and 
the root system. Weka's Color 
Clustering algorithm is a versatile ImageJ plugin that can be used to segment images using different color channels
and various algorithmic settings. The **Color Clustering** plugin allows you to save an output as a .model file, which
can be used on other images to produce consistent segmentations. This model file is used in the method.
 
 
 To compute Nodule Distances, we use LingDong's skeletonization implementation[@Skeleton] to convert our segmented
 root system into a 1 pixel wide representation of the root system. From there, we use the skeleton to create a graph 
 and use Dijkstra's algorithm to compute the shortest path between nodules along the root system. 
 
# Implementation


 
## Implementation Overview

I'll first break the Nodule Segmentation Method up into general steps, and then go into details of those steps.

1. Segment the nodules, producing a binary map.
2. Organize the pixels into red, green, or mixed nodules.
3. Create and clean the ROIs.
4. If a nodule is mixed, attempt to correct the outline.
5. Allow the user to make corrections.
6. Save the data as a CSV and two images.

---

## Nodule Segmentation


As a first step, the algorithm utilizes the model file generated by Weka's **Color Clustering** plugin 
and creates the binary image. There are optional steps 
afterward that attempt to improve the segmentation by checking neighborhoods around the already located ROIs. 
If background pixels have a "high enough" green value (relative to the average green value in the image), they 
may be reconsidered as part of a nodule.

The reasoning behind this was that in our dataset, images that were darker had a harder time segmenting the nodules
 as their relative brightness was lower than what the model file was accustomed to. To address this, four buckets 
 were created based on the image’s average green level across all pixels. A similar approach was used for red, but 
 instead of a neighborhood-based correction, a separate `.model` file was created specifically for red-channel 
 segmentation. This file was excellent at identifying red nodules, and if the average red value was low enough, 
 this algorithm was used to refine red nodule detection.

---

## Pixel Categorization
 
Once all nodule pixels have been located, they are separated into three arrays based on their red and green values. 
They are classified using the lines shown in. Notably, there is a curvature when graphing 
red vs. green values.

- **Mixed nodule pixels** are found in the center of the curves (yellow pixels where red and green mix).
- **Green nodule pixels** are on the lower part of the curve.
- **Red nodule pixels** are on the upper part of the curve.

The segmentation lines were determined through heuristic methods on multiple dataset images. We manually adjusted
 the segmentation boundaries to ensure all mixed nodules were captured while keeping the tightest possible boundaries.

---

## ROI Detection and Processing

To find and measure the ROIs, we proceeded with these steps:

1. **Hole Filling**: Some nodule pixels are marked black, but there may be white pixels inside these black objects. Any such holes are filled with black.
2. **Threshold to ROI Conversion**: ImageJ’s `ij.plugin.filter.ThresholdToSelection` algorithm is used to outline each object in the binary map. This produces a single ROI containing all outlined objects.
3. **ROI Separation**: The singular ROI is split into an array of disjoint ROIs, each corresponding to a detected nodule.
4. **Data Collection**: ImageJ commands collect data such as:
   - Area
   - Fraction of area
   - Circularity
5. **Noise Filtering**: A lower area threshold removes ROIs likely caused by noise. **(User-set threshold at runtime needed)**.
6. **Splitting Clumped Nodules**: If an ROI is large enough, it is assumed to be multiple nodules and is split accordingly.

---

## Handling Mixed Nodules

Mixed nodules are treated differently than other nodule types. Instead of outlining the entire mixed nodule, 
the algorithm outlines only the **yellow portion** of what is likely a mixed nodule.

During testing, increasing the segmentation area resulted in more mixed nodule ROIs but also introduced noise. 
To address this, we implemented a **manual verification step**. Since the number of mixed nodules per image is 
relatively low, the user is prompted to review detected mixed nodules and confirm their classification. Incorrect 
ROIs are removed.

After this, the remaining mixed nodule ROIs are merged with neighboring red and green ROIs if they are within 1 pixel. 
Finally, their areas are recalculated, and their red and green pixel counts are recorded.

---

## Manual Adjustments

At this stage, all data has been processed, and we provide a **manual override** feature. A GUI (Figure 2) appears,
 allowing users to:
- Click on ROIs to adjust them.
- Click "Finish" once the data is satisfactory.


#Results

We have ran the segmentation on over two hundred images producing csv files of the data and images such as in.
 This output has been used in Niall's PhD defense. Additionally, There is a biologist at Washington 
 State University currently using output from the recently finished Nodule Distances plugin to test certain hypothesis, with
 
 results incoming. 
 
#Conclusions

There are some quality of life improvements that could be made to the plugin, but it is currently fully functional and 
I am interested in having it available to be used by other researches in the bio space.

By the way, Dr. Kyle, the methods, implementation, results, and conclusions sections were added for the purpose of the 
course, but I would appreicate any feedback regarding the rest of this write up as it pertains to publishing to Joss. Any 
feedback in that regard would be greatly appreciated. 

# Acknowledgements

This project was funded by Porter Labs from Washington State University and 
it's development and improvement was aided by Niall Miller and Brianna Banting.

# References